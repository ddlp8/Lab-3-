//no estoy segura si si deberia de funcionar así
#include <Arduino.h>

/****************************************/
// Pines para LEDs (Manual)
#define ledManual_0 18
#define ledManual_1 21
#define ledManual_2 22
#define ledManual_3 23

// Pines para LEDs (Automático)
#define ledAuto_0   14
#define ledAuto_1   25
#define ledAuto_2   27
#define ledAuto_3   26

// LED de Alarma
#define ledAlarma   19

// Botones
#define pinSube     15
#define pinBaja     4

/****************************************/
// Variables globales
volatile uint8_t contadorManual = 0;
volatile uint8_t contadorAuto = 0;
volatile bool subio = false;
volatile bool bajo = false;
bool estadoAlarma = false;             // Estado del LED blanco
volatile bool coincidenciaDetectada = false; // Bandera de flanco de coincidencia

const unsigned long pausa = 200;
volatile unsigned long tSube = 0;
volatile unsigned long tBaja = 0;

hw_timer_t* tmrAuto = NULL;

/****************************************/
// Prototipos
void apagarLedsManual();
void apagarLedsAuto();
void verBinarioManual(uint8_t valor);
void verBinarioAuto(uint8_t valor);
void IRAM_ATTR ISR_subirManual();
void IRAM_ATTR ISR_bajarManual();
void IRAM_ATTR ISR_contadorAutomatico();

/****************************************/
void setup() {
  // LEDs Manuales
  pinMode(ledManual_0, OUTPUT);
  pinMode(ledManual_1, OUTPUT);
  pinMode(ledManual_2, OUTPUT);
  pinMode(ledManual_3, OUTPUT);

  // LEDs Automáticos
  pinMode(ledAuto_0, OUTPUT);
  pinMode(ledAuto_1, OUTPUT);
  pinMode(ledAuto_2, OUTPUT);
  pinMode(ledAuto_3, OUTPUT);

  // LED de Alarma
  pinMode(ledAlarma, OUTPUT);
  digitalWrite(ledAlarma, LOW);

  // Botones
  pinMode(pinSube, INPUT_PULLUP);
  pinMode(pinBaja, INPUT_PULLUP);

  // Estado inicial
  apagarLedsManual();
  apagarLedsAuto();
  verBinarioManual(contadorManual);
  verBinarioAuto(contadorAuto);

  delay(100);  // Estabilización

  // Interrupciones de botones
  attachInterrupt(digitalPinToInterrupt(pinSube), ISR_subirManual, FALLING);
  attachInterrupt(digitalPinToInterrupt(pinBaja), ISR_bajarManual, FALLING);

  // Temporizador automático: cada 250 ms
  tmrAuto = timerBegin(0, 80, true); // 80 prescaler → 1 tick = 1 µs
  timerAttachInterrupt(tmrAuto, &ISR_contadorAutomatico, true);
  timerAlarmWrite(tmrAuto, 250000, true);
  timerAlarmEnable(tmrAuto);
}

/****************************************/
void loop() {
  unsigned long ahora = millis();

  if (subio && (ahora - tSube > pausa)) {
    contadorManual = (contadorManual + 1) % 16;
    verBinarioManual(contadorManual);
    subio = false;
  }

  if (bajo && (ahora - tBaja > pausa)) {
    contadorManual = (contadorManual == 0) ? 15 : contadorManual - 1;
    verBinarioManual(contadorManual);
    bajo = false;
  }
}

/****************************************/
// Subrutinas no interrupción

void apagarLedsManual() {
  digitalWrite(ledManual_0, LOW);
  digitalWrite(ledManual_1, LOW);
  digitalWrite(ledManual_2, LOW);
  digitalWrite(ledManual_3, LOW);
}

void apagarLedsAuto() {
  digitalWrite(ledAuto_0, LOW);
  digitalWrite(ledAuto_1, LOW);
  digitalWrite(ledAuto_2, LOW);
  digitalWrite(ledAuto_3, LOW);
}

void verBinarioManual(uint8_t n) {
  apagarLedsManual();
  if (n & (1 << 0)) digitalWrite(ledManual_0, HIGH);
  if (n & (1 << 1)) digitalWrite(ledManual_1, HIGH);
  if (n & (1 << 2)) digitalWrite(ledManual_2, HIGH);
  if (n & (1 << 3)) digitalWrite(ledManual_3, HIGH);
}

void verBinarioAuto(uint8_t n) {
  apagarLedsAuto();
  if (n & (1 << 0)) digitalWrite(ledAuto_0, HIGH);
  if (n & (1 << 1)) digitalWrite(ledAuto_1, HIGH);
  if (n & (1 << 2)) digitalWrite(ledAuto_2, HIGH);
  if (n & (1 << 3)) digitalWrite(ledAuto_3, HIGH);
}

/****************************************/
// Rutinas de interrupción

void IRAM_ATTR ISR_subirManual() {
  unsigned long t = millis();
  if (t - tSube > pausa) {
    subio = true;
    tSube = t;
  }
}

void IRAM_ATTR ISR_bajarManual() {
  unsigned long t = millis();
  if (t - tBaja > pausa) {
    bajo = true;
    tBaja = t;
  }
}

void IRAM_ATTR ISR_contadorAutomatico() {
  static uint8_t pasosDesdeCoincidencia = 0;

  contadorAuto = (contadorAuto + 1) % 16;
  verBinarioAuto(contadorAuto);

  // Detectar coincidencia exacta
  if (contadorAuto == contadorManual && !coincidenciaDetectada) {
    coincidenciaDetectada = true;

    // Cambiar estado del LED blanco
    estadoAlarma = !estadoAlarma;
    digitalWrite(ledAlarma, estadoAlarma ? HIGH : LOW);

    // Reiniciar el contador automático para nuevo ciclo
    contadorAuto = 0;
    pasosDesdeCoincidencia = 0;
    verBinarioAuto(contadorAuto);
  }

  // Esperar a que se deshaga la coincidencia para detectar la próxima
  if (contadorAuto != contadorManual) {
    coincidenciaDetectada = false;
  }
}
